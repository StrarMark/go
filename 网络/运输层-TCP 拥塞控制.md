### 一、拥塞控制概述

所谓 TCP 拥塞控制就是防止过多的数据注入到网络中，这样可以使网络中的路由器或者链路不至于过载。

拥塞控制是一个全局性的过程，涉及到所有的主机、路由器，拥塞控制不能清楚的知道拥塞发生在何处，也无法知道具体发生拥塞的原因。而流量控制是指点对点通信的控制，是端到端的问题。

当出现过度的拥塞时，在沿着这条路径上的一台（或多台）路由器的缓存会溢出，引起一个数据报被丢弃，丢弃的数据报接着会引起发送方的丢包事件（超时或者收到冗余 ACK），发送方就认为路径上出现了拥塞的指示。

运行在发送方的 TCP 拥塞控制系统跟踪一个额外的变量，即拥塞窗口（congestion window）。拥塞窗口表示为 cwnd，它对一个 TCP 发送方能向网络中发送流量的速率进行了限制。

### 二、拥塞控制方法

实践过程中主要采用两种主要拥塞控制方法，如下：

 - 端到端拥塞控制。在端到端拥塞控制方法中，网络层没有为运输层拥塞控制提供任何显示支持。TCP 正是采用端到端的方法来解决拥塞控制，因为 IP 层不会向端系统提供任何有关网络拥塞的信息。
 - 网络辅助的拥塞控制。在网络辅助的拥塞控制中，路由器会向发送方提供关于网络中拥塞状态的显示反馈信息。
 
TCP 必须使用端到端拥塞控制而不是网络辅助的拥塞控制，因为 IP 层不向端系统提供显示的网络拥塞反馈。TCP 会让每一个发送方根据所感知的网络拥塞程度来限制其他连接发送流量的速率。

一个 TCP 发送发不会收到来自网络层的明确拥塞控制指示，而是通过观察分组丢失来判断拥塞。

### 三、拥塞控制算法

TCP 拥塞控制算法主要包括 3 个部分：

 1. 慢启动
 2. 拥塞避免
 3. 快速恢复

其中慢启动和拥塞避免是 TCP 的强制部分，两者的差异在于对收到的 ACK 做出反应时增加 cwnd（拥塞窗口） 长度的方式。快速恢复对于 TCP 是推荐部分，并不是必需的。
 
**3.1 慢启动** 

当一条 TCP 连接开始时，cwnd 初始值往往设置为一个 MSS 的较小值。在慢启动状态，cwnd 的值以 1 个 MSS 开始，并且每当传输的报文段被首次确认后增加一个 MSS。因此，TCP 起始速率较慢，但在慢启动状态阶段以指数形式增长。

但是，在何时结束这种指数增长呢？主要有以下 3 种答案：

 1. 如果存在一个超时指示的丢包事件（拥塞），TCP 发送方就将 cwnd 的值设置为 1 个 MSS 并重新开始慢启动过程。除此之外，它还将另一个状态变量 ssthresh（慢启动阈值）设置为 cwnd/2。即当检测到拥塞控制时将 ssthresh 置为拥塞窗口的一半。
 2. 直接与 ssthresh 相连，因为当检测到拥塞时，ssthresh 设为 cwnd 的值的一半，当到达或超过 ssthresh 时，继续使 cwnd 翻番可能有些鲁莽。因此，当 cwnd 的值等于 ssthresh 时，则结束慢启动并将 TCP 转移到拥塞避免状态。
 3. 如果检测到 3 个冗余的 ACK，此时 TCP 执行一种快速重传，并进入快速恢复状态。

**3.2 拥塞避免**

一旦进入拥塞避免状态，cwnd 的值大约是上次拥塞控制时的一半。即距离拥塞控制可能很近。因此，TCP 无法每过一个 RTT 就将 cwnd 翻倍，而是采用了一种较为保守的方法，每个 RTT 只将 cwnd 的值增加一个 MSS。

**3.3 快速恢复**

在快速恢复中，对于引起 TCP 进入快速恢复状态的缺失报文段，对收到的每个冗余 ACK，cwnd 的值增加一个 MSS。最终，对于丢失报文段的一个 ACK 到达时，TCP 在降低 cwnd 后进入拥塞避免状态。

如果出现超时事件，快速恢复在执行如同在慢启动和拥塞避免中相同的动作后，迁移到慢启动状态；当丢包事件发生时，cwnd 的值被置为 1 个 MSS 大小，并且 ssthresh 的值被置为 cwnd 值的一半。

PS：

 - MSS（Maximum Segment Size）最大TCP分段大小，不包含TCP头和 option，只包含TCP Payload ，TCP用来限制自己每次发送的最大分段尺寸。



### 参考

[车小胖谈网络：MTU 与 MSS](https://zhuanlan.zhihu.com/p/21268782) by 车小胖 <br>
[TCP慢启动、拥塞避免、快速重传、快速恢复](https://blog.csdn.net/itmacar/article/details/12278769) by iTerry7758 <br>