### 一、Redis 主从复制

Redis 中可以通过命令 `SLAVEOF host port` 和配置 `slaveof` 配置项，让服务器（从服务器）复制另一个服务器（主服务器）上的数据，经过复制过后，从服务器与主服务器状态一致。

主从复制有以下几个优点：

 - 数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式
 - 故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余
 - 负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写 Redis 数据时应用连接主节点，读 Redis 数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高 Redis 服务器的并发量

### 二、主从复制原理

从服务器对主服务器的同步通过向主服务器发送 `PSYNC` 命令完成，下面是执行步骤：

 1. 从服务器向主服务器发送 `PSYNC` 命令
 2. 主服务器接收到 `PSYNC` 命令后执行 `BGSAVE` 命令在后台生成一个 RDB 文件，并使用一个缓冲区记录从现在开始执行的所有写命令（todo 这个缓冲区是否有限制？）
 3. RDB 文件生成后，主服务器将 RDB 文件发送给从服务器，从服务器接收到 RDB 后会载入该文件
 4. 主服务器将缓冲区记录的所有写命令发送给从服务器，从服务器执行完写命令后，数据库状态与主服务器保持一致
 
同步操作完成后，会进行命令传播操作，每当主服务器执行完一条写命令后，主服务器执行完后会将该命令发送给从服务器，从服务器执行完写命令后就又与主服务器保持一致了。

复制分为完整重同步和部分重同步两种情况：

 - 完全重同步：完整重同步用于处理初次复制情况
 - 部分重同步：部分重同步用于处理断线后的复制情况，当从服务器断线后重新连接到主服务器时，如果条件允许，主服务器可以将从服务器连接断开期间执行的写命令发送给从服务器，从服务器只要执行这些写命令，就可以将数据库的状态与主服务器保持一致

#### 2.1 部分重同步原理

 部分重同步功能由以下数据结构完成：

  - 主服务器的复制偏移量和从服务器的复制偏移量
  - 主服务器的复制积压缓冲区
  - 服务器的运行 ID

##### 2.1.1 复制偏移量

主节点和从节点分别维护一个复制偏移量（offset），代表的是主节点向从节点传递的字节数；主节点每次向从节点传播 N 个字节数据时，主节点的 offset 增加 N；从节点每次收到主节点传来的 N 个字节数据时，从节点的 offset 增加 N。

offset 用于判断主从节点的数据库状态是否一致：如果二者 offset 相同，则一致；如果 offset 不同，则不一致，此时可以根据两个 offset 找出从节点缺少的那部分数据。

##### 2.1.2 复制积压缓冲区

复制积压缓冲区是由主节点维护的、固定长度的、先进先出 (FIFO) 队列，默认大小 1MB；当主节点开始有从节点时创建，其作用是备份主节点最近发送给从节点的数据。

在命令传播阶段，主节点除了将写命令发送给从节点，还会发送一份给复制积压缓冲区，作为写命令的备份；除了存储写命令，复制积压缓冲区中还存储了其中的每个字节对应的复制偏移量（offset）。由于复制积压缓冲区定长且是先进先出，所以它保存的是主节点最近执行的写命令；时间较早的写命令会被挤出缓冲区。

从节点将 offset 发送给主节点后，主节点根据 offset 和缓冲区大小决定能否执行部分复制：

 - 如果 offset 偏移量之后的数据，仍然都在复制积压缓冲区里，则执行部分复制
 - 如果 offset 偏移量之后的数据已不在复制积压缓冲区中（数据已被挤出），则执行全量复制

##### 2.1.3 服务器运行 ID

每个 Redis 节点 (无论主从)，在启动时都会自动生成一个随机 ID(每次启动都不一样)，由 40 个随机的十六进制字符组成；runid 用来唯一识别一个 Redis 节点。通过 `info Server` 命令，可以查看节点的 runid：

主从节点初次复制时，主节点将自己的 runid 发送给从节点，从节点将这个 runid 保存起来；当断线重连时，从节点会将这个 runid 发送给主节点；主节点根据 runid 判断能否进行部分复制：

 - 如果从节点保存的 runid 与主节点现在的 runid 相同，说明主从节点之前同步过，主节点会继续尝试使用部分复制 (到底能不能部分复制还要看 offset 和复制积压缓冲区的情况)
 - 如果从节点保存的 runid 与主节点现在的 runid 不同，说明从节点在断线前同步的 Redis 节点并不是当前的主节点，只能进行全量复制

#### 3.2 psync 命令执行原理

 ![](https://images2018.cnblogs.com/blog/1174710/201806/1174710-20180628011547892-692403928.png)

### 三、心跳检测

在命令传播阶段，从节点会向主节点发送 REPLCONF ACK 命令，频率是每秒 1 次；命令格式为：`REPLCONF ACK {offset}`，其中 offset 指从节点保存的复制偏移量。REPLCONF ACK 命令的作用包括：

 1. 实时监测主从节点网络状态：该命令会被主节点用于复制超时的判断。此外，在主节点中使用 info Replication，可以看到其从节点的状态中的 lag 值，代表的是主节点上次收到该 REPLCONF ACK 命令的时间间隔，在正常情况下，该值应该是 0 或 1
 2. 检测命令丢失：从节点发送了自身的 offset，主节点会与自己的 offset 对比，如果从节点数据缺失（如网络丢包），主节点会推送缺失的数据（这里也会利用复制积压缓冲区）。注意，offset 和复制积压缓冲区，不仅可以用于部分复制，也可以用于处理命令丢失等情形；区别在于前者是在断线重连后进行的，而后者是在主从节点没有断线的情况下进行的
 3. 辅助保证从节点的数量和延迟：Redis 主节点中使用 `min-slaves-to-write` 和 `min-slaves-max-lag` 参数，来保证主节点在不安全的情况下不会执行写命令；所谓不安全，是指从节点数量太少，或延迟过高。例如 `min-slaves-to-write` 和 `min-slaves-max-lag` 分别是 3 和 10，含义是如果从节点数量小于 3 个，或所有从节点的延迟值都大于 10s，则主节点拒绝执行写命令。而这里从节点延迟值的获取，就是通过主节点接收到 REPLCONF ACK 命令的时间来判断的，即前面所说的 info Replication 中的 lag 值

### 四、复制过程

![](https://pic3.zhimg.com/80/v2-572931fbda09102b25968eccc858b6aa_1440w.jpg)

### other

下面是 redis.conf 文件中一些关于主从复制的配置：

- `replica-read-only`：从节点是否只读，默认值 yes，因此从服务器默认不支持修改操作
- `repl-backlog-size`：复制积压缓冲区内存大小，默认 1mb

### 参考

《Redis 设计与实现》 黄建宏 著 <br>
[深入学习 Redis（3）：主从复制 ](https://www.cnblogs.com/kismetv/p/9236731.html#t67) <br>
[深入Redis：详解 Redis主从复制的原理!](https://zhuanlan.zhihu.com/p/60239657)